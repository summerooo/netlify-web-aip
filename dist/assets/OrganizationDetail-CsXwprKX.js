import{y as xe,r as u,l as Z,c as h,h as $e,z as C,A as m,R as t,J as a,al as i,aC as je,B as n,O as s,u as F,P as v,I as z,L as U,Q as Oe,a6 as Ue,aB as Ie,W as Pe}from"./vendor-D5A_PLSQ.js";import{E as d,q as De,p as Me,u as Fe}from"./ui-DUo8Dfqk.js";import{u as Le,s as ie}from"./index-1yu-MD6X.js";import{a as Be,b as Ee,u as Re,e as Se,l as qe,r as Ae}from"./organizations-DV3rHeUx.js";import{g as Ne,c as Te,u as Je}from"./projects-C6oOc8Q2.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./supabase-C1h6x9Gt.js";const We={class:"organization-detail"},Ge={class:"header-left"},He={class:"org-info"},Ke={class:"header-right"},Xe={class:"projects-section"},Ye={key:0,class:"loading"},Ze={key:1,class:"empty-state"},he={key:2,class:"projects-grid"},et={class:"project-header"},tt={class:"project-status-actions"},lt={class:"project-desc"},at={class:"project-meta"},ot={class:"members-section"},nt={class:"members-header"},st={key:1,class:"no-permission-text"},rt={class:"settings-section"},it={key:0,class:"danger-zone"},dt={class:"danger-actions"},ut={class:"invitation-link-dialog"},mt={class:"invitation-link-container"},pt={key:0,class:"invitation-info"},vt={class:"leave-dialog-content"},ct=xe({__name:"OrganizationDetail",setup(ft){const _=je(),de=Ie(),c=Le(),ee=u("projects"),A=u(!1),w=u(null),N=u([]),L=u([]),x=u(!1),$=u(!1),B=u(!1),I=u(!1),T=u(!1),te=u(!1),J=u(!1),j=u(""),Q=u(null),W=u(!1),f=Z({name:"",description:"",status:"计划中"}),P=Z({email:"",role:"member"}),y=Z({name:"",description:""}),G=u(),ue={name:[{required:!0,message:"请输入项目名称",trigger:"blur"}]},H=h(()=>{if(!c.user||!L.value.length)return!1;const o=L.value.find(e=>{var p;return e.user_id===((p=c.user)==null?void 0:p.id)});return(o==null?void 0:o.role)==="admin"}),le=h(()=>c.user&&w.value&&w.value.created_by===c.user.id),O=h(()=>le.value||H.value),ae=async()=>{try{const o=await Be(_.params.id);w.value=o,y.name=o.name,y.description=o.description||""}catch(o){d.error("加载组织信息失败: "+o.message)}},K=async()=>{try{const o=await Ne(_.params.id);N.value=o}catch(o){d.error("加载项目列表失败: "+o.message)}},oe=async()=>{try{const o=await Ee(_.params.id);L.value=o}catch(o){d.error("加载成员列表失败: "+o.message)}},me=async()=>{G.value&&await G.value.validate(async o=>{var e,p,r;if(o){T.value=!0;try{const{data:g}=await ie.from("organizations").select("created_by").eq("id",_.params.id).single(),E=(g==null?void 0:g.created_by)===((e=c.user)==null?void 0:e.id);let R=!1;if(!E){const{data:b}=await ie.from("organization_members").select("role").eq("organization_id",_.params.id).eq("user_id",(p=c.user)==null?void 0:p.id).single();R=(b==null?void 0:b.role)==="admin"}if(!E&&!R)throw new Error("只有组织创建者或管理员才能创建项目");if(!((r=c.user)!=null&&r.id))throw new Error("用户未登录");await Te({name:f.name,description:f.description,status:f.status,organization_id:_.params.id,created_by:c.user.id}),d.success("项目创建成功"),x.value=!1,ge(),K()}catch(g){d.error("创建项目失败: "+g.message),console.error("创建项目错误详情:",g)}finally{T.value=!1}}})},pe=async o=>{try{await Ae(o),d.success("成员已移除"),oe()}catch(e){d.error("移除成员失败: "+e.message)}},ve=async()=>{try{const o={name:y.name,description:y.description};console.log("更新数据:",o),console.log("settingsForm:",y),await Re(_.params.id,o),d.success("设置已保存"),ae()}catch(o){d.error("保存设置失败: "+o.message)}},ce=async()=>{if(!j.value){d.warning("没有可复制的邀请链接");return}W.value=!0;try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(j.value),d.success("邀请链接已复制到剪贴板");else{const o=document.createElement("textarea");o.value=j.value,o.style.position="fixed",o.style.opacity="0",document.body.appendChild(o),o.select();const e=document.execCommand("copy");document.body.removeChild(o),e?d.success("邀请链接已复制到剪贴板"):d.error("复制失败：浏览器不支持复制功能")}}catch(o){console.error("复制错误:",o),d.error("复制失败: "+(o.message||"未知错误"))}finally{W.value=!1}},fe=async()=>{te.value=!0;try{console.log("正在创建组织邀请，参数:",{organizationId:_.params.id,role:P.role});const o=await Se(_.params.id,P.role,"","");console.log("邀请创建成功，返回数据:",o);const e=_.params.id,p=o.invitationToken||o.token;if(!p)throw new Error("邀请创建成功但未返回有效的 token");const g=`${window.location.origin}/accept-organization-invitation?token=${p}&organizationId=${e}`;console.log("生成的邀请链接:",g),j.value=g,Q.value=o,B.value=!0,$.value=!1,d.success("邀请链接已生成，请复制发送给被邀请人")}catch(o){d.error("创建邀请失败: "+o.message),console.error("邀请错误详情:",o)}finally{te.value=!1}},ge=()=>{f.name="",f.description="",f.status="计划中"},_e=async(o,e)=>{try{await Je(o,{status:e}),d.success("项目状态更新成功")}catch(p){d.error("更新项目状态失败: "+p.message),K()}},ye=async()=>{if(!(!c.user||!w.value)){J.value=!0;try{await qe(w.value.id),d.success("已成功退出组织"),I.value=!1,de.push("/organizations")}catch(o){console.error("退出组织失败:",o),d.error("退出组织失败: "+(o.message||"未知错误"))}finally{J.value=!1}}},ne=o=>new Date(o).toLocaleDateString("zh-CN");return $e(async()=>{A.value=!0;try{await Promise.all([ae(),K(),oe()])}finally{A.value=!1}}),(o,e)=>{const p=i("el-icon"),r=i("el-button"),g=i("el-header"),E=i("el-skeleton"),R=i("el-empty"),b=i("el-option"),se=i("el-select"),be=i("el-card"),X=i("el-tab-pane"),D=i("el-table-column"),ke=i("el-tag"),we=i("el-table"),M=i("el-input"),V=i("el-form-item"),re=i("el-alert"),Y=i("el-form"),Ve=i("el-tabs"),Ce=i("el-main"),ze=i("el-container"),S=i("el-dialog");return m(),C("div",We,[t(ze,null,{default:a(()=>[t(g,{class:"header"},{default:a(()=>{var l,k;return[n("div",Ge,[t(r,{type:"text",onClick:e[0]||(e[0]=q=>o.$router.back()),class:"back-btn"},{default:a(()=>[t(p,null,{default:a(()=>[t(F(De))]),_:1}),e[22]||(e[22]=s(" 返回 ",-1))]),_:1}),n("div",He,[n("h1",null,v((l=w.value)==null?void 0:l.name),1),n("p",null,v(((k=w.value)==null?void 0:k.description)||"暂无描述"),1)])]),n("div",Ke,[H.value?(m(),z(r,{key:0,type:"primary",onClick:e[1]||(e[1]=q=>x.value=!0)},{default:a(()=>[t(p,null,{default:a(()=>[t(F(Me))]),_:1}),e[23]||(e[23]=s(" 创建项目 ",-1))]),_:1})):U("",!0)])]}),_:1}),t(Ce,null,{default:a(()=>[t(Ve,{modelValue:ee.value,"onUpdate:modelValue":e[8]||(e[8]=l=>ee.value=l),class:"org-tabs"},{default:a(()=>[t(X,{label:"项目",name:"projects"},{default:a(()=>[n("div",Xe,[A.value?(m(),C("div",Ye,[t(E,{rows:3,animated:""})])):N.value.length===0?(m(),C("div",Ze,[t(R,{description:"暂无项目"},{default:a(()=>[H.value?(m(),z(r,{key:0,type:"primary",onClick:e[2]||(e[2]=l=>x.value=!0)},{default:a(()=>[...e[24]||(e[24]=[s(" 创建第一个项目 ",-1)])]),_:1})):U("",!0)]),_:1})])):(m(),C("div",he,[(m(!0),C(Oe,null,Ue(N.value,l=>(m(),z(be,{key:l.id,class:"project-card",shadow:"hover",onClick:k=>o.$router.push(`/projects/${l.id}`)},{default:a(()=>[n("div",et,[n("h3",null,v(l.name),1),n("div",tt,[t(se,{modelValue:l.status,"onUpdate:modelValue":k=>l.status=k,size:"small",onClick:e[3]||(e[3]=Pe(()=>{},["stop"])),onChange:k=>_e(l.id,k),class:"status-select"},{default:a(()=>[t(b,{label:"计划中",value:"计划中"}),t(b,{label:"进行中",value:"进行中"}),t(b,{label:"已完成",value:"已完成"}),t(b,{label:"已暂停",value:"已暂停"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])])]),n("p",lt,v(l.description||"暂无描述"),1),n("div",at,[n("span",null,"创建时间: "+v(ne(l.created_at)),1)])]),_:2},1032,["onClick"]))),128))]))])]),_:1}),t(X,{label:"成员",name:"members"},{default:a(()=>[n("div",ot,[n("div",nt,[e[26]||(e[26]=n("h3",null,"组织成员",-1)),O.value?(m(),z(r,{key:0,type:"primary",onClick:e[4]||(e[4]=l=>$.value=!0)},{default:a(()=>[t(p,null,{default:a(()=>[t(F(Fe))]),_:1}),e[25]||(e[25]=s(" 邀请成员 ",-1))]),_:1})):U("",!0)]),t(we,{data:L.value,style:{width:"100%"}},{default:a(()=>[t(D,{label:"姓名"},{default:a(({row:l})=>[s(v(l.full_name||l.name||l.email||"未知用户"),1)]),_:1}),t(D,{label:"邮箱"},{default:a(({row:l})=>[s(v(l.email||"未知邮箱"),1)]),_:1}),t(D,{prop:"role",label:"角色"},{default:a(({row:l})=>[t(ke,{type:l.role==="admin"?"danger":"info"},{default:a(()=>[s(v(l.role==="admin"?"管理员":"成员"),1)]),_:2},1032,["type"])]),_:1}),t(D,{prop:"joined_at",label:"加入时间"},{default:a(({row:l})=>[s(v(ne(l.joined_at)),1)]),_:1}),t(D,{label:"操作",width:"120"},{default:a(({row:l})=>{var k,q;return[O.value&&l.role!=="admin"&&l.user_id!==((k=F(c).user)==null?void 0:k.id)?(m(),z(r,{key:0,type:"danger",size:"small",onClick:gt=>pe(l.id)},{default:a(()=>[...e[27]||(e[27]=[s(" 移除 ",-1)])]),_:1},8,["onClick"])):O.value?U("",!0):(m(),C("span",st,v(l.user_id===((q=F(c).user)==null?void 0:q.id)?"自己":"无权限"),1))]}),_:1})]),_:1},8,["data"])])]),_:1}),t(X,{label:"设置",name:"settings"},{default:a(()=>[n("div",rt,[t(Y,{model:y,"label-width":"100px"},{default:a(()=>[t(V,{label:"组织名称"},{default:a(()=>[t(M,{modelValue:y.name,"onUpdate:modelValue":e[5]||(e[5]=l=>y.name=l),disabled:!O.value},null,8,["modelValue","disabled"])]),_:1}),t(V,{label:"组织描述"},{default:a(()=>[t(M,{modelValue:y.description,"onUpdate:modelValue":e[6]||(e[6]=l=>y.description=l),type:"textarea",rows:3,disabled:!O.value},null,8,["modelValue","disabled"])]),_:1}),O.value?(m(),z(V,{key:0},{default:a(()=>[t(r,{type:"primary",onClick:ve},{default:a(()=>[...e[28]||(e[28]=[s(" 保存设置 ",-1)])]),_:1})]),_:1})):(m(),z(V,{key:1},{default:a(()=>[t(re,{title:"只有组织创建者或管理员才能修改组织设置",type:"info",closable:!1})]),_:1}))]),_:1},8,["model"]),le.value?U("",!0):(m(),C("div",it,[e[31]||(e[31]=n("h3",null,"危险操作",-1)),n("div",dt,[e[30]||(e[30]=n("p",null,"退出组织后，您将失去对该组织及其项目的访问权限。",-1)),t(r,{type:"danger",onClick:e[7]||(e[7]=l=>I.value=!0)},{default:a(()=>[...e[29]||(e[29]=[s(" 退出组织 ",-1)])]),_:1})])]))])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(S,{modelValue:x.value,"onUpdate:modelValue":e[12]||(e[12]=l=>x.value=l),title:"创建项目",width:"500px"},{footer:a(()=>[t(r,{onClick:e[11]||(e[11]=l=>x.value=!1)},{default:a(()=>[...e[32]||(e[32]=[s("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:me,loading:T.value},{default:a(()=>[...e[33]||(e[33]=[s(" 创建 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(Y,{ref_key:"projectFormRef",ref:G,model:f,rules:ue,"label-width":"80px"},{default:a(()=>[t(V,{label:"项目名称",prop:"name"},{default:a(()=>[t(M,{modelValue:f.name,"onUpdate:modelValue":e[9]||(e[9]=l=>f.name=l)},null,8,["modelValue"])]),_:1}),t(V,{label:"项目描述",prop:"description"},{default:a(()=>[t(M,{modelValue:f.description,"onUpdate:modelValue":e[10]||(e[10]=l=>f.description=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(S,{modelValue:$.value,"onUpdate:modelValue":e[15]||(e[15]=l=>$.value=l),title:"邀请成员",width:"400px"},{footer:a(()=>[t(r,{onClick:e[14]||(e[14]=l=>$.value=!1)},{default:a(()=>[...e[34]||(e[34]=[s("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:fe},{default:a(()=>[...e[35]||(e[35]=[s("邀请",-1)])]),_:1})]),default:a(()=>[t(Y,{model:P,"label-width":"80px"},{default:a(()=>[t(V,{label:"邀请角色"},{default:a(()=>[t(se,{modelValue:P.role,"onUpdate:modelValue":e[13]||(e[13]=l=>P.role=l),style:{width:"100%"}},{default:a(()=>[t(b,{label:"成员",value:"member"}),t(b,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),t(V,null,{default:a(()=>[t(re,{title:"邀请说明",description:"生成邀请链接后，任何通过此链接访问的用户都可以加入组织",type:"info",closable:!1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(S,{modelValue:B.value,"onUpdate:modelValue":e[19]||(e[19]=l=>B.value=l),title:"成员邀请链接",width:"500px"},{footer:a(()=>[t(r,{onClick:e[17]||(e[17]=l=>B.value=!1)},{default:a(()=>[...e[41]||(e[41]=[s("关闭",-1)])]),_:1}),t(r,{type:"primary",onClick:e[18]||(e[18]=l=>$.value=!0)},{default:a(()=>[...e[42]||(e[42]=[s(" 发送另一个邀请 ",-1)])]),_:1})]),default:a(()=>[n("div",ut,[e[40]||(e[40]=n("p",null,"邀请已发送，请复制以下链接发送给被邀请人：",-1)),n("div",mt,[t(M,{modelValue:j.value,"onUpdate:modelValue":e[16]||(e[16]=l=>j.value=l),readonly:"",class:"invitation-link-input"},{append:a(()=>[t(r,{onClick:ce,loading:W.value},{default:a(()=>[...e[36]||(e[36]=[s(" 复制链接 ",-1)])]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),Q.value?(m(),C("div",pt,[e[38]||(e[38]=n("p",null,[n("strong",null,"邀请类型："),s("通用邀请链接")],-1)),n("p",null,[e[37]||(e[37]=n("strong",null,"成员角色：",-1)),s(v(Q.value.role==="admin"?"管理员":"成员"),1)]),e[39]||(e[39]=n("p",null,[n("strong",null,"说明："),s("任何通过此链接访问的用户都可以以该角色加入组织")],-1))])):U("",!0)])]),_:1},8,["modelValue"]),t(S,{modelValue:I.value,"onUpdate:modelValue":e[21]||(e[21]=l=>I.value=l),title:"确认退出组织",width:"400px"},{footer:a(()=>[t(r,{onClick:e[20]||(e[20]=l=>I.value=!1)},{default:a(()=>[...e[46]||(e[46]=[s("取消",-1)])]),_:1}),t(r,{type:"danger",onClick:ye,loading:J.value},{default:a(()=>[...e[47]||(e[47]=[s(" 确认退出 ",-1)])]),_:1},8,["loading"])]),default:a(()=>{var l;return[n("div",vt,[n("p",null,[e[43]||(e[43]=s("您确定要退出组织 ",-1)),n("strong",null,v((l=w.value)==null?void 0:l.name),1),e[44]||(e[44]=s(" 吗？",-1))]),e[45]||(e[45]=n("p",{class:"warning-text"},"退出后，您将失去对该组织及其所有项目的访问权限。",-1))])]}),_:1},8,["modelValue"])])}}}),zt=Qe(ct,[["__scopeId","data-v-efcedce1"]]);export{zt as default};
