import{E as w,u as O}from"./ui-DUo8Dfqk.js";import{u as $,s as P}from"./index-1yu-MD6X.js";import{y as j,r as c,l as F,h as J,z as y,A as _,R as r,J as s,al as u,B as v,I as T,L as R,u as G,O as i,P as H}from"./vendor-D5A_PLSQ.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./supabase-C1h6x9Gt.js";const Q={class:"profile-container"},W={class:"card-header"},X={class:"profile-content"},Y={class:"avatar-section"},Z={key:0,class:"avatar-upload"},ee={key:1,class:"password-actions"},re={key:2,class:"form-actions"},se=j({__name:"Profile",setup(ae){const m=$(),b=c(),V=c(),d=c(!1),k=c(!1),C=c(!1),x=c(!1),n=F({id:"",email:"",full_name:"",avatar_url:"",created_at:""}),o=F({currentPassword:"",newPassword:"",confirmPassword:""}),h=(l,e,a)=>{e!==o.newPassword?a(new Error("两次输入的密码不一致")):a()},B={full_name:[{required:!0,message:"请输入姓名",trigger:"blur"},{min:2,message:"姓名长度不能少于2位",trigger:"blur"},{max:20,message:"姓名长度不能超过20位",trigger:"blur"}]},N={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:h,trigger:"blur"}]},U=async()=>{var l;if(m.user)try{const{data:e,error:a}=await P.from("user_profiles").select("*").eq("id",m.user.id).single();if(a)throw a;if(e)Object.assign(n,e);else{const{error:g}=await P.from("user_profiles").insert({id:m.user.id,email:m.user.email,full_name:((l=m.user.user_metadata)==null?void 0:l.full_name)||""});if(g)throw g;await U()}}catch(e){w.error("加载用户资料失败: "+e.message),console.error("加载用户资料错误:",e)}},z=async()=>{b.value&&await b.value.validate(async l=>{var e;if(l){k.value=!0;try{const{error:a}=await P.from("user_profiles").update({full_name:n.full_name}).eq("id",(e=m.user)==null?void 0:e.id);if(a)throw a;w.success("资料更新成功"),d.value=!1}catch(a){w.error("更新资料失败: "+a.message),console.error("更新资料错误:",a)}finally{k.value=!1}}})},D=async()=>{V.value&&await V.value.validate(async l=>{if(l){C.value=!0;try{const{error:e}=await P.auth.updateUser({password:o.newPassword});if(e)throw e;w.success("密码更新成功"),q()}catch(e){w.error("更新密码失败: "+e.message),console.error("更新密码错误:",e)}finally{C.value=!1}}})},M=()=>{d.value=!1,U()},q=()=>{x.value=!1,o.currentPassword="",o.newPassword="",o.confirmPassword=""},S=l=>l?new Date(l).toLocaleString("zh-CN"):"";return J(()=>{U()}),(l,e)=>{const a=u("el-button"),g=u("el-icon"),A=u("el-avatar"),p=u("el-input"),f=u("el-form-item"),E=u("el-form"),I=u("el-divider"),L=u("el-card");return _(),y("div",Q,[r(L,{class:"profile-card"},{header:s(()=>[v("div",W,[e[7]||(e[7]=v("h2",null,"个人资料",-1)),r(a,{type:"primary",onClick:e[0]||(e[0]=t=>d.value=!d.value)},{default:s(()=>[i(H(d.value?"取消编辑":"编辑资料"),1)]),_:1})])]),default:s(()=>[v("div",X,[v("div",Y,[r(A,{size:100,src:n.avatar_url},{default:s(()=>[r(g,null,{default:s(()=>[r(G(O))]),_:1})]),_:1},8,["src"]),d.value?(_(),y("div",Z,[r(a,{size:"small",type:"text"},{default:s(()=>[...e[8]||(e[8]=[i("更换头像",-1)])]),_:1})])):R("",!0)]),r(E,{ref_key:"profileFormRef",ref:b,model:n,rules:B,"label-width":"100px",class:"profile-form"},{default:s(()=>[r(f,{label:"姓名",prop:"full_name"},{default:s(()=>[r(p,{modelValue:n.full_name,"onUpdate:modelValue":e[1]||(e[1]=t=>n.full_name=t),disabled:!d.value,placeholder:"请输入姓名"},null,8,["modelValue","disabled"])]),_:1}),r(f,{label:"邮箱",prop:"email"},{default:s(()=>[r(p,{modelValue:n.email,"onUpdate:modelValue":e[2]||(e[2]=t=>n.email=t),disabled:"",placeholder:"邮箱地址"},null,8,["modelValue"]),e[9]||(e[9]=v("div",{class:"form-tip"},"邮箱地址不可修改",-1))]),_:1}),r(f,{label:"注册时间"},{default:s(()=>[r(p,{value:S(n.created_at),disabled:""},null,8,["value"])]),_:1})]),_:1},8,["model"]),r(I,{"content-position":"left"},{default:s(()=>[...e[10]||(e[10]=[i("密码设置",-1)])]),_:1}),x.value?(_(),T(E,{key:0,ref_key:"passwordFormRef",ref:V,model:o,rules:N,"label-width":"100px",class:"password-form"},{default:s(()=>[r(f,{label:"当前密码",prop:"currentPassword"},{default:s(()=>[r(p,{modelValue:o.currentPassword,"onUpdate:modelValue":e[3]||(e[3]=t=>o.currentPassword=t),type:"password",placeholder:"请输入当前密码","show-password":""},null,8,["modelValue"])]),_:1}),r(f,{label:"新密码",prop:"newPassword"},{default:s(()=>[r(p,{modelValue:o.newPassword,"onUpdate:modelValue":e[4]||(e[4]=t=>o.newPassword=t),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),r(f,{label:"确认密码",prop:"confirmPassword"},{default:s(()=>[r(p,{modelValue:o.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=t=>o.confirmPassword=t),type:"password",placeholder:"请确认新密码","show-password":""},null,8,["modelValue"])]),_:1}),r(f,null,{default:s(()=>[r(a,{type:"primary",onClick:D,loading:C.value},{default:s(()=>[...e[11]||(e[11]=[i(" 更新密码 ",-1)])]),_:1},8,["loading"]),r(a,{onClick:q},{default:s(()=>[...e[12]||(e[12]=[i("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):(_(),y("div",ee,[r(a,{type:"text",onClick:e[6]||(e[6]=t=>x.value=!0)},{default:s(()=>[...e[13]||(e[13]=[i(" 修改密码 ",-1)])]),_:1})])),d.value?(_(),y("div",re,[r(a,{type:"primary",onClick:z,loading:k.value},{default:s(()=>[...e[14]||(e[14]=[i(" 保存修改 ",-1)])]),_:1},8,["loading"]),r(a,{onClick:M},{default:s(()=>[...e[15]||(e[15]=[i("取消",-1)])]),_:1})])):R("",!0)])]),_:1})])}}}),ue=K(se,[["__scopeId","data-v-78429bc5"]]);export{ue as default};
